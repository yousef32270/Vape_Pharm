<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vape Pharm ‚Äî The Smoker's Heaven</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --accent: #bfa15f; /* Refined gold, less yellow */
      --accent-light: rgba(191, 161, 95, 0.2);
    }

    /* Global Styles */
    body {
      margin: 0;
      font-family: 'Orbitron', sans-serif;
      background: radial-gradient(ellipse at center, #1a1a1a 0%, #0d0d0d 100%);
      color: #fff;
      overflow: hidden;
      position: relative;
    }

    /* Floating particles animation */
    .particles {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .particle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      opacity: 0.8;
      animation: floatParticle 8s linear infinite;
    }
    @keyframes floatParticle {
      0% { transform: translateY(0) translateX(0); }
      50% { transform: translateY(-100vh) translateX(50px); }
      100% { transform: translateY(0) translateX(0); }
    }

    /* Top Header */
    .top-header {
      position: relative;
      z-index: 2;
      background: linear-gradient(to right, #333, #222);
      padding: 20px;
      font-size: 2rem;
      font-weight: 800;
      text-align: center;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      box-shadow: 0 0 25px var(--accent-light);
    }

    /* Layout Wrapper */
    .layout {
      display: flex;
      height: calc(100vh - 80px);
      z-index: 2;
      position: relative;
    }

    /* Sidebar */
    .sidebar {
      width: 270px;
      background-color: rgba(0, 0, 0, 0.7);
      border-right: 1px solid rgba(255, 255, 255, 0.05);
      padding: 30px 20px;
      box-shadow: inset -1px 0 20px var(--accent-light);
    }
    .sidebar ul {
      list-style: none;
      padding: 0;
    }
    .sidebar li {
      margin-bottom: 20px;
    }
    .sidebar a,
    .sidebar button {
      display: block;
      width: 100%;
      padding: 14px;
      font-size: 15px;
      color: var(--accent);
      background-color: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(191, 161, 95, 0.2);
      border-radius: 12px;
      text-align: left;
      text-decoration: none;
      transition: all 0.3s ease;
    }
    .sidebar a:hover,
    .sidebar button:hover {
      background: rgba(191, 161, 95, 0.12);
      color: #fff;
      box-shadow: 0 0 18px rgba(191, 161, 95, 0.4);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 50px 60px;
      overflow-y: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(191, 161, 95, 0.15);
      border-radius: 25px;
      padding: 40px;
      box-shadow: 0 0 60px rgba(191, 161, 95, 0.05), 0 0 200px rgba(191, 161, 95, 0.08);
      backdrop-filter: blur(12px);
    }
    .header {
      font-size: 2.8rem;
      color: var(--accent);
      font-weight: 800;
      margin-bottom: 10px;
    }
    .btn-god {
      background: linear-gradient(to right, var(--accent), #8c7d54);
      border: none;
      color: #000;
      padding: 14px 35px;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 12px;
      margin-right: 12px;
      transition: 0.3s ease;
      box-shadow: 0 0 12px rgba(191, 161, 95, 0.6);
    }
    .btn-god:hover {
      background: #e0d6b8;
      box-shadow: 0 0 30px rgba(191, 161, 95, 1);
    }
    .btn-danger {
      padding: 14px 35px;
      border-radius: 12px;
      font-size: 1rem;
    }
    .visualizer {
      width: 100%;
      height: 180px;
      background-color: rgba(255, 255, 255, 0.04);
      border-radius: 18px;
      margin-bottom: 30px;
      box-shadow: inset 0 0 20px rgba(191, 161, 95, 0.07);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    canvas.border {
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .text-muted {
      color: #ccc;
    }

    /* Modified animated element ‚Äì Refined rotating crown icon */
    .rotating-crown {
      width: 50px;
      height: 50px;
      margin: 20px auto;
      background-image: url('https://img.icons8.com/fluency/48/000000/crown.png');
      background-size: contain;
      background-repeat: no-repeat;
      animation: rotateCrown 8s linear infinite;
    }
    @keyframes rotateCrown {
      0% { transform: rotate(0deg) scale(1); opacity: 1; }
      50% { transform: rotate(180deg) scale(1.05); opacity: 0.95; }
      100% { transform: rotate(360deg) scale(1); opacity: 1; }
    }
  </style>
</head>
<body>

  <!-- Floating Particles in the Background -->
  <div class="particles">
    <div class="particle" style="top: 10%; left: 20%; animation-duration: 10s;"></div>
    <div class="particle" style="top: 40%; left: 80%; animation-duration: 12s;"></div>
    <div class="particle" style="top: 70%; left: 30%; animation-duration: 9s;"></div>
    <div class="particle" style="top: 50%; left: 50%; animation-duration: 11s;"></div>
    <div class="particle" style="top: 20%; left: 70%; animation-duration: 8s;"></div>
    <div class="particle" style="top: 80%; left: 10%; animation-duration: 13s;"></div>
  </div>

  <!-- Divine Header -->
  <div class="top-header">
    Vape Pharm - The Smoker's Heaven
  </div>

  <!-- Main Layout -->
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <ul>
        <li><a href="{{ url_for('home') }}">üè† Dashboard</a></li>
        <li><a href="{{ url_for('projects') }}">üß† Projects</a></li>
        <li><a href="{{ url_for('settings') }}">‚öôÔ∏è Settings</a></li>
        <li><button id="managerButton">ü™¨ Manager Instruction</button></li>
        <li><button id="showHistoryButton">üìú Show History</button></li>
        <li><button id="clearHistoryButton">üßº Clear History</button></li>
        <li><a href="{{ url_for('logout') }}" onclick="return confirm('Are you sure you want to logout?')">üö™ Logout</a></li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="glass-card">
        <div class="rotating-crown"></div>
        <h1 class="header">Vape Pharm </h1>
        <p class="text-muted">Command your divine voice assistant and transcend mortal limitations.</p>

        <button id="startButton" class="btn btn-god mb-4">Activate </button>
        <button id="stopBotButton" class="btn btn-danger mb-4">Silence </button>

        <p><strong>üéß User Voice:</strong></p>
        <canvas id="localVisualizer" class="visualizer border"></canvas>

        <p><strong>üîä Ai AGENT:</strong></p>
        <canvas id="backendVisualizer" class="visualizer border"></canvas>
      </div>
    </main>
  </div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let aiBotActive = true;
  let pc = null;
  let micStream = null;

  const originalConsoleError = console.error;
  console.error = (...args) => {
    originalConsoleError(...args);
    alert(`See browser console for details: ${args.join(' ')}`);
  };

  document.getElementById("startButton").addEventListener("click", async () => {
    if (!aiBotActive) {
      alert("AI Bot is currently stopped.");
      return;
    }
    try {
      await init();
    } catch (error) {
      console.error("Error in init():", error);
    }
  });

  document.getElementById("managerButton").addEventListener("click", () => {
    aiBotActive = true;
    listenAndSendToGPT();
  });

  document.getElementById("stopBotButton").addEventListener("click", () => {
    aiBotActive = false;
    if (pc) {
      pc.getSenders().forEach(sender => pc.removeTrack(sender));
      pc.close();
      pc = null;
      console.log("Peer connection closed.");
    }
    if (micStream) {
      micStream.getTracks().forEach(track => track.stop());
      micStream = null;
      console.log("Microphone stream stopped.");
    }
    alert("AI Bot Stopped and connection closed.");
  });

  document.getElementById("showHistoryButton").addEventListener("click", () => {
    window.location.href = "/history";
  });

  document
  .getElementById("clearHistoryButton")
  .addEventListener("click", () => {
    Swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, do it!'
    }).then(async (swalResult) => {
      if (swalResult.isConfirmed) {
        try {
          const clearResponse = await fetch("/reset_prompt", { method: "POST" });
          if (!clearResponse.ok) {
            throw new Error(`Failed to clear history. HTTP ${clearResponse.status}`);
          }
          const data = await clearResponse.json();
          showDivineMessage("üßº Prompt and history cleared successfully!", "success");
          console.log("Action confirmed!");
        } catch (error) {
          console.error("Error clearing history:", error);
          showDivineMessage("‚ùå Failed to clear prompt/history", "danger");
        }
      } else {
        console.log("Action canceled!");
      }
    });
  });

  async function init() {
  try {
    console.log("üü° Init started...");
    const tokenResponse = await fetch("/session");

    const contentType = tokenResponse.headers.get("content-type") || "";
    if (!tokenResponse.ok || !contentType.includes("application/json")) {
      throw new Error("Expected JSON response but got something else.");
    }

      const tokenData = await tokenResponse.json();
      const EPHEMERAL_KEY = tokenData.client_secret.value;
      console.log("‚úÖ EPHEMERAL_KEY:", EPHEMERAL_KEY);

      // Setup Peer Connection
      pc = new RTCPeerConnection();
      const audioEl = document.createElement("audio");
      audioEl.autoplay = true;
      document.body.appendChild(audioEl);

      pc.ontrack = (e) => {
        if (e.streams[0]) {
          console.log("üéß Received remote stream from OpenAI.");
          audioEl.srcObject = e.streams[0];
          startVisualizer(e.streams[0], 'backendVisualizer', '#ff0000');
        }
      };

      console.log("üéôÔ∏è Requesting microphone permission...");
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      pc.addTrack(micStream.getTracks()[0]);
      console.log("‚úÖ Microphone acquired.");
      startVisualizer(micStream, 'localVisualizer', '#007bff');

      console.log("üõ†Ô∏è Creating SDP offer...");
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      console.log("üì° Sending offer to OpenAI...");
      const sdpResponse = await fetch(
        "https://api.openai.com/v1/realtime?model=gpt-4o-realtime-preview-2024-12-17",
        {
          method: "POST",
          body: offer.sdp,
          headers: {
            Authorization: `Bearer ${EPHEMERAL_KEY}`,
            "Content-Type": "application/sdp"
          }
        }
      );

      if (!sdpResponse.ok) {
        throw new Error(`‚ùå Failed to get SDP answer. HTTP ${sdpResponse.status}`);
      }

      const answer = { type: "answer", sdp: await sdpResponse.text() };
      await pc.setRemoteDescription(answer);

      console.log("‚úÖ WebRTC connection established!");
      showDivineMessage("‚ú® AI Bot is now active and listening!", "success");

    } catch (error) {
      console.error("‚ùå Error in init():", error);
      showDivineMessage(`‚ùå Error: ${error.message}`, "danger");
    }
  }

  function startVisualizer(stream, canvasId, color) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    const audioContext = new AudioContext();
    const analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    audioContext.createMediaStreamSource(stream).connect(analyser);
    function draw() {
      requestAnimationFrame(draw);
      analyser.getByteTimeDomainData(dataArray);
      ctx.fillStyle = '#f5f5f5';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = color;
      ctx.beginPath();
      const sliceWidth = canvas.width / dataArray.length;
      let x = 0;
      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] / 128.0;
        const y = v * canvas.height / 2;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
        x += sliceWidth;
      }
      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.stroke();
    }
    draw();
  }
    async function listenAndSendToGPT() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('SpeechRecognition not supported in this browser.');
        return;
      }
      const recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.start();
      recognition.onresult = async (event) => {
        const transcript = event.results[0][0].transcript;
        console.log("Manager's voice instruction recognized:", transcript);
        try {
          const saveResponse = await fetch('/save_and_update_prompt', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ refined_text: transcript })
          });
          if (!saveResponse.ok) {
            throw new Error(`Failed to save instructions. HTTP ${saveResponse.status}`);
          }

          // üîÑ New elegant success box
          const oldAlert = document.getElementById("instructionSuccess");
          if (oldAlert) oldAlert.remove();

          const successDiv = document.createElement("div");
          successDiv.id = "instructionSuccess";
          successDiv.className = "alert alert-success mt-4";
          successDiv.style.maxWidth = "600px";
          successDiv.innerHTML = "‚úÖ Refined data saved and AI Prompt updated!";

          document.querySelector(".glass-card").appendChild(successDiv);

          setTimeout(() => {
            // remove your old successDiv
            successDiv.remove();

            // fire a SweetAlert2 toast
            Swal.fire({
              toast: true,
              position: 'top-end',
              icon: 'success',
              title: '‚ú® AI Prompt updated!',
              showConfirmButton: false,
              timer: 5000,
              timerProgressBar: true,

              // optional custom styling
              background: '#1a1a2e',    // deep navy
              color: '#f0f0f0',         // off‚Äëwhite text
              customClass: {
                popup: 'rounded-2xl shadow-2xl p-3',
                title: 'text-lg font-semibold',
                icon: 'text-2xl'
              }
            });
          }, 5000);

          
        } catch (error) {
          console.error('Error saving refined instruction:', error);
        }
      };
      recognition.onerror = (err) => {
        console.error('Speech recognition error:', err);
      };
    }
    function showDivineMessage(message, type = "success", timeout = 4000) {
      const oldAlert = document.getElementById("divineAlert");
      if (oldAlert) oldAlert.remove();

      const alertDiv = document.createElement("div");
      alertDiv.id = "divineAlert";
      alertDiv.className = `alert alert-${type}`;
      alertDiv.style.position = "fixed";
      alertDiv.style.top = "30px";
      alertDiv.style.left = "50%";
      alertDiv.style.transform = "translateX(-50%)";
      alertDiv.style.zIndex = "9999";
      alertDiv.style.padding = "16px 30px";
      alertDiv.style.fontSize = "1.1rem";
      alertDiv.style.fontWeight = "600";
      alertDiv.style.color = "#000";
      alertDiv.style.background = type === "success"
        ? "linear-gradient(to right, #d9c37d, #bfa15f)"
        : type === "danger"
        ? "#f44336"
        : "#ffc107";
      alertDiv.style.border = "1px solid rgba(255,255,255,0.2)";
      alertDiv.style.borderRadius = "12px";
      alertDiv.style.boxShadow = "0 0 40px rgba(191, 161, 95, 0.5)";
      alertDiv.style.transition = "opacity 1s ease";

      alertDiv.textContent = message;
      document.body.appendChild(alertDiv);

      setTimeout(() => {
        alertDiv.style.opacity = "0";
        setTimeout(() => alertDiv.remove(), 1000);
      }, timeout);
    }


</script>
</body>
</html>
